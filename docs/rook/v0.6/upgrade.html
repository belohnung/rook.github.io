












































<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    
    <meta name="robots" content="noindex">
    

    <title>Ceph Docs</title>

    <link rel="canonical" href="https://rook.io/docs/rook/v0.6/upgrade.html">

    <link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/images/favicon_16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon_32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon_48x48.png" sizes="48x48" />
<link rel="icon" type="image/png" href="/images/favicon_192x192.png" sizes="192x192" />


    <link href="//fonts.googleapis.com/css?family=Montserrat:500|Open+Sans:300,400,600" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/main.css">
    
      <link rel="stylesheet" href="/css/docs.css" />
    
  </head>
  <body>
    <nav id="navigation" aria-label="Navigation">
  <div>
    <div class="logo">
      <a href="/"><img src="/images/rook-logo.svg"/></a>
    </div>
    <div
      class="hamburger-controls"
      onclick="if (document.body.classList.contains('menu-open')) { document.body.classList.remove('menu-open') } else { document.body.classList.add('menu-open') }; return false;">
      <span></span> <span></span> <span></span>
    </div>
    <ul class="links">
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Documentation</a>
        <div class="dropdown-content">
          <a href="/docs/rook/v1.9/">Ceph</a>
          <a href="/docs/cassandra/v1.7/">Cassandra</a>
          <a href="/docs/nfs/v1.7/">NFS</a>
        </div>
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Community</a>
        <div class="dropdown-content">
          <a href="//github.com/rook/rook">GitHub</a>
          <a href="//slack.rook.io/">Slack</a>
          <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
          <a href="//twitter.com/rook_io">Twitter</a>
        </div>
      </li>
      <li><a href="//blog.rook.io/">Blog</a></li>
      <li><a class="button small" href="/docs/rook/v1.9/quickstart.html">Get Started</a></li>
    </ul>
  </div>
</nav>

    <main id="content" aria-label="Content"><div>



















<section class="docs-header">
  <h1>Ceph</h1>
  <div class="versions">
    <a role="button" href="javascript:void(0)">Rook Ceph v0.6</a>
    <div class="versions-dropdown-content">
      
        <a href="/docs/rook/v1.9/upgrade.html">Rook Ceph v1.9</a>
      
        <a href="/docs/rook/v1.8/upgrade.html">Rook Ceph v1.8</a>
      
        <a href="/docs/rook/v1.7/upgrade.html">Rook Ceph v1.7</a>
      
        <a href="/docs/rook/v1.6/upgrade.html">Rook Ceph v1.6</a>
      
        <a href="/docs/rook/v1.5/upgrade.html">Rook Ceph v1.5</a>
      
        <a href="/docs/rook/v1.4/upgrade.html">Rook Ceph v1.4</a>
      
        <a href="/docs/rook/v1.3/upgrade.html">Rook Ceph v1.3</a>
      
        <a href="/docs/rook/v1.2/upgrade.html">Rook Ceph v1.2</a>
      
        <a href="/docs/rook/v1.1/upgrade.html">Rook Ceph v1.1</a>
      
        <a href="/docs/rook/v1.0/upgrade.html">Rook Ceph v1.0</a>
      
        <a href="/docs/rook/v0.9/upgrade.html">Rook Ceph v0.9</a>
      
        <a href="/docs/rook/v0.8/upgrade.html">Rook Ceph v0.8</a>
      
        <a href="/docs/rook/v0.7/upgrade.html">Rook Ceph v0.7</a>
      
        <a href="/docs/rook/v0.6/upgrade.html" class="active">Rook Ceph v0.6</a>
      
        <a href="/docs/rook/v0.5/upgrade.html">Rook Ceph v0.5</a>
      
        <a href="/docs/rook/latest/upgrade.html">Rook Ceph latest</a>
      
    </div>
    <img src="/images/arrow.svg" />
  </div>
</section>
<div class="page">
  <div class="docs-menu">
      <ul id="docs-ul"></ul>
  </div>
  <div class="docs-content">
    <div class="docs-actions">
      <a id="edit" href="https://github.com/rook/rook/blob/master/Documentation/upgrade.md">Edit on GitHub</a>
    </div>
    
      <div class="alert old">
        <p><b>PLEASE NOTE</b>: This document applies to v0.6 version and not to the latest <strong>stable</strong> release v1.9</p>
      </div>
    
    <div class="docs-text">
      <h1 id="upgrading-the-rook-software">Upgrading the Rook Software</h1>
<p>This guide will walk you through the manual steps to upgrade the software in a Rook cluster from one version to the next.
Rook is a distributed software system and therefore there are multiple components to individually upgrade in the sequence defined in this guide.
After each component is upgraded, it is important to verify that the cluster returns to a healthy and fully functional state.</p>

<p>This guide is just the beginning of upgrade support in Rook.
The goal is to provide prescriptive guidance and knowledge on how to upgrade a live Rook cluster and we hope to get valuable feedback from the community that will be incorporated into an automated upgrade solution by the Rook operator.</p>

<p>We welcome feedback and opening issues!</p>

<h2 id="considerations">Considerations</h2>
<p>With this manual upgrade guide, there are a few notes to consider:</p>
<ul>
  <li><strong>WARNING:</strong> Upgrading a Rook cluster is a manual process in its very early stages.  There may be unexpected issues or obstacles that damage the integrity and health of your storage cluster, including data loss.  Only proceed with this guide if you are comfortable with that.</li>
  <li>Rook is still in an alpha state.  Migrations and general support for breaking changes across versions are not supported or covered in this guide.</li>
  <li>This guide assumes that your Rook operator and its agents are running in the <code class="language-plaintext highlighter-rouge">rook-system</code> namespace. It also assumes that your Rook cluster is in the <code class="language-plaintext highlighter-rouge">rook</code> namespace.  If any of these components is in a different namespace, search/replace all instances of <code class="language-plaintext highlighter-rouge">-n rook-system</code> and <code class="language-plaintext highlighter-rouge">-n rook</code> in this guide with <code class="language-plaintext highlighter-rouge">-n &lt;your namespace&gt;</code>.</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>
<p>In order to successfully upgrade a Rook cluster, the following prerequisites must be met:</p>
<ul>
  <li>The cluster should be in a healthy state with full functionality.
Review the <a href="#health-verification">health verification section</a> in order to verify your cluster is in a good starting state.</li>
  <li><code class="language-plaintext highlighter-rouge">dataDirHostPath</code> must be set in your Cluster spec.
This persists metadata on host nodes, enabling pods to be terminated during the upgrade and for new pods to be created in their place.
More details about <code class="language-plaintext highlighter-rouge">dataDirHostPath</code> can be found in the <a href="/docs/rook/v0.6/cluster-crd.html#cluster-settings">Cluster CRD readme</a>.</li>
  <li>All pods consuming Rook storage should be created, running, and in a steady state.  No Rook persistent volumes should be in the act of being created or deleted.</li>
</ul>

<p>The minimal sample Cluster spec that will be used in this guide can be found below (note that the specific configuration may not be applicable to all environments):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Namespace
metadata:
  name: rook
---
apiVersion: rook.io/v1alpha1
kind: Cluster
metadata:
  name: rook
  namespace: rook
spec:
  versionTag: v0.5.0
  dataDirHostPath: /var/lib/rook
  storage:
    useAllNodes: true
    useAllDevices: true
    storeConfig:
      storeType: bluestore
      databaseSizeMB: 1024
      journalSizeMB: 1024
</code></pre></div></div>

<h2 id="health-verification">Health Verification</h2>
<p>Before we begin the upgrade process, let’s first review some ways that you can verify the health of your cluster, ensuring that the upgrade is going smoothly after each step.
Most of the health verification checks for your cluster during the upgrade process can be performed with the Rook toolbox.
For more information about how to run the toolbox, please visit the <a href="/docs/rook/v0.6/toolbox.html#running-the-toolbox-in-kubernetes">Rook toolbox readme</a>.</p>

<h3 id="pods-all-running">Pods all Running</h3>
<p>In a healthy Rook cluster, the operator, the agents and all Rook namespace pods should be in the <code class="language-plaintext highlighter-rouge">Running</code> state and have few, if any, pod restarts.
To verify this, run the following commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system get pods
kubectl <span class="nt">-n</span> rook get pod
</code></pre></div></div>
<p>If pods aren’t running or are restarting due to crashes, you can get more information with <code class="language-plaintext highlighter-rouge">kubectl describe pod</code> and <code class="language-plaintext highlighter-rouge">kubectl logs</code> for the affected pods.</p>

<h3 id="status-output">Status Output</h3>
<p>The Rook toolbox contains the <code class="language-plaintext highlighter-rouge">rookctl</code> command line tool that can give you status details of the cluster with the <code class="language-plaintext highlighter-rouge">rookctl status</code> command.
Let’s look at some sample output and review some of the details:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> kubectl <span class="nt">-n</span> rook <span class="nb">exec</span> <span class="nt">-it</span> rook-tools <span class="nt">--</span> rookctl status
OVERALL STATUS: OK

USAGE:
TOTAL       USED        DATA         AVAILABLE
26.62 GiB   12.25 GiB   252.76 MiB   14.37 GiB

MONITORS:
NAME             ADDRESS             IN QUORUM   STATUS
rook-ceph-mon2   10.3.0.15:6790/0    <span class="nb">true        </span>OK
rook-ceph-mon0   10.3.0.129:6790/0   <span class="nb">true        </span>OK
rook-ceph-mon1   10.3.0.218:6790/0   <span class="nb">true        </span>OK

MGRs:
NAME             STATUS
rook-ceph-mgr0   Active

OSDs:
TOTAL     UP        IN        FULL      NEAR FULL
6         6         6         <span class="nb">false     false

</span>PLACEMENT GROUPS <span class="o">(</span>900 total<span class="o">)</span>:
STATE          COUNT
active+clean   900
</code></pre></div></div>
<p>In the output above, note the following indications that the cluster is in a healthy state:</p>
<ul>
  <li>Overall status: The overall cluster status is <code class="language-plaintext highlighter-rouge">OK</code> and there are no warning or error status messages displayed.</li>
  <li>Monitors:  All of the monitors are <code class="language-plaintext highlighter-rouge">in quorum</code> and have individual status of <code class="language-plaintext highlighter-rouge">OK</code>.</li>
  <li>OSDs: All OSDs are <code class="language-plaintext highlighter-rouge">UP</code> and <code class="language-plaintext highlighter-rouge">IN</code>.</li>
  <li>MGRs: All Ceph managers are in the <code class="language-plaintext highlighter-rouge">Active</code> state.</li>
  <li>Placement groups: All PGs are in the <code class="language-plaintext highlighter-rouge">active+clean</code> state.</li>
</ul>

<p>If your <code class="language-plaintext highlighter-rouge">rookctl status</code> output has deviations from the general good health described above, there may be an issue that needs to be investigated further.</p>

<h3 id="pod-version">Pod Version</h3>
<p>The version of a specific pod in the Rook cluster can be verified in its pod spec output.  For example, for the monitor pod <code class="language-plaintext highlighter-rouge">mon0</code>, we can verify the version it is running with the below commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MON0_POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">mon</span><span class="o">=</span>rook-ceph-mon0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> rook get pod <span class="k">${</span><span class="nv">MON0_POD_NAME</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.containers[0].image}'</span>
</code></pre></div></div>

<h3 id="all-pods-status-and-version">All Pods Status and Version</h3>
<p>The status and version of all Rook pods can be collected all at once with the following commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system get pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\n\t"}{.status.phase}{"\t"}{.spec.containers[0].image}{"\n"}{end}'</span>
kubectl <span class="nt">-n</span> rook get pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\n\t"}{.status.phase}{"\t"}{.spec.containers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<h3 id="rook-volume-health">Rook Volume Health</h3>
<p>Any pod that is using a Rook volume should also remain healthy:</p>
<ul>
  <li>The pod should be in the <code class="language-plaintext highlighter-rouge">Running</code> state with no restarts</li>
  <li>There shouldn’t be any errors in its logs</li>
  <li>The pod should still be able to read and write to the attached Rook volume.</li>
</ul>

<h2 id="upgrade-process">Upgrade Process</h2>
<p>The general flow of the upgrade process will be to upgrade the version of a Rook pod, verify the pod is running with the new version, then verify that the overall cluster health is still in a good state.</p>

<p>In this guide, we will be upgrading a live Rook cluster running <code class="language-plaintext highlighter-rouge">v0.5.0</code> to the next available version of <code class="language-plaintext highlighter-rouge">v0.5.1</code>.
Let’s get started!</p>

<h3 id="cluster-version-tag">Cluster Version Tag</h3>
<p>The first step in the upgrade process is to update the Cluster spec’s <code class="language-plaintext highlighter-rouge">versionTag</code> field.
This value is used as the version for any other Rook components that the operator may bring up later on in the cluster’s lifecycle.
We can begin editing it with the following <code class="language-plaintext highlighter-rouge">kubectl</code> command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook edit cluster.rook.io rook
</code></pre></div></div>
<p>This will bring up your default text editor with the cluster spec loaded and ready for editing.
In your editor, simply update <code class="language-plaintext highlighter-rouge">versionTag: v0.5.0</code> to now be <code class="language-plaintext highlighter-rouge">versionTag: v0.5.1</code>, then save and quit your editor.</p>

<h3 id="operator">Operator</h3>
<p>The Rook operator is the management brains of the cluster, so it should be upgraded first before other components.
In the event that the new version requires a migration of metadata or config, the operator is the one that would understand how to perform that migration.</p>

<p>The operator is managed by a Kubernetes deployment, so in order to upgrade the version of the operator pod, we will need to edit the image version of the pod template in the deployment spec.  This can be done with the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system <span class="nb">set </span>image deployment/rook-operator rook-operator<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>
<p>Once the command is executed, Kubernetes will begin the flow of the deployment updating the operator pod.</p>

<h4 id="operator-health-verification">Operator Health Verification</h4>
<p>To verify the operator pod is <code class="language-plaintext highlighter-rouge">Running</code> and using the new version of <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code>, use the following commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">OPERATOR_POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> rook-system get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-operator <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> rook-system get pod <span class="k">${</span><span class="nv">OPERATOR_POD_NAME</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.phase}{"\n"}{.spec.containers[0].image}{"\n"}'</span>
</code></pre></div></div>

<p>Once you’ve verified the operator is <code class="language-plaintext highlighter-rouge">Running</code> and on the new version, verify the health of the cluster is still OK.
Instructions for verifying cluster health can be found in the <a href="#health-verification">health verification section</a>.</p>

<h3 id="agents">Agents</h3>
<p>The Rook agents are deployed by the operator to run on every node. They are in charge of handling all operations related to the consumption of storage from the cluster.</p>

<p>The agents are deployed and managed by a Kubernetes daemonset. So in order to upgrade the version of the agent pods, we will need to edit the image version of the pod template in the daemonset spec and then delete each agent pod so that a new pod is created by the daemonset.</p>

<p>The following command updates the image of the agent daemonset:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system <span class="nb">set </span>image daemonset/rook-agent rook-agent<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>Once the daemonset is updated, we can begin deleting each agent pod <strong>one at a time</strong> and verifying a new one comes up to replace it that is running the new version.</p>

<p>The following is an example of deleting just one of the agent pods (note that the names of your agent pods will be different):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system delete pod rook-agent-56m61
</code></pre></div></div>

<p>After all the agent pods have been updated, verify that they are <code class="language-plaintext highlighter-rouge">Running</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook-system get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-agent
</code></pre></div></div>

<h3 id="api">API</h3>
<p>Similar to the operator, the Rook API pod is managed by a Kubernetes deployment.
However, this time we will edit the deployment directly, because there is another field besides just the image version that needs to be updated in the Rook API deployment.
Begin editing the deployment with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook edit deployment rook-api
</code></pre></div></div>

<p>Note there are 2 fields that need to be updated.
These are the two relevant snippets you should update in your editor to use the new version of <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code> as shown:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        - name: ROOK_VERSION_TAG
          value: v0.5.1
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        image: rook/rook:v0.5.1
        imagePullPolicy: IfNotPresent
        name: rook-api
</code></pre></div></div>

<p>After updating the version fields, the <code class="language-plaintext highlighter-rouge">rook-api</code> deployment should terminate the old pod and start a new one using the new version.
We can verify the new pod is in the <code class="language-plaintext highlighter-rouge">Running</code> state and using the new version with these commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">API_POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-api <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> rook get pod <span class="k">${</span><span class="nv">API_POD_NAME</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.phase}{"\n"}{.spec.containers[0].image}{"\n"}'</span>
</code></pre></div></div>

<p>Remember to verify the cluster health using the instructions found in the <a href="#health-verification">health verification section</a>.</p>

<h3 id="monitors">Monitors</h3>
<p>There are multiple monitor pods to upgrade and they are each individually managed by their own replica set.
<strong>For each</strong> monitor’s replica set, you will need to update the pod template spec’s image version field to <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code>.
For example, we can update the replica set for <code class="language-plaintext highlighter-rouge">mon0</code> with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook <span class="nb">set </span>image replicaset/rook-ceph-mon0 rook-ceph-mon<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>Once the replica set has been updated, we need to manually terminate the old pod which will trigger the replica set to create a new pod using the new version.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MON0_POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">mon</span><span class="o">=</span>rook-ceph-mon0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> rook delete pod <span class="k">${</span><span class="nv">MON0_POD_NAME</span><span class="k">}</span>
</code></pre></div></div>

<p>After the new monitor pod comes up, we can verify that it’s in the <code class="language-plaintext highlighter-rouge">Running</code> state and on the new version:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MON0_POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">mon</span><span class="o">=</span>rook-ceph-mon0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> rook get pod <span class="k">${</span><span class="nv">MON0_POD_NAME</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.phase}{"\n"}{.spec.containers[0].image}{"\n"}'</span>
</code></pre></div></div>

<p>At this point, it’s very important to ensure that all monitors are <code class="language-plaintext highlighter-rouge">OK</code> and <code class="language-plaintext highlighter-rouge">in quorum</code>.
Refer to the <a href="#status-output">status output section</a> for instructions.
If all of the monitors (and the cluster health overall) look good, then we can move on and repeat the same upgrade steps for the next monitor until all are completed.</p>

<p><strong>NOTE:</strong> In the <code class="language-plaintext highlighter-rouge">v0.5.x</code> releases, the Rook operator is aggressive about replacing monitor pods that it finds out of quorum, even if it’s only for a short time.
It is possible while upgrading your monitor pods that the operator will find them out of quorum and immediately replace them with a new monitor, such as <code class="language-plaintext highlighter-rouge">mon0</code> getting replaced by <code class="language-plaintext highlighter-rouge">mon3</code>.
This is okay as long as the cluster health looks good and all monitors eventually reach quorum again.</p>

<h3 id="object-storage-daemons-osds">Object Storage Daemons (OSDs)</h3>
<p>The OSD pods can be managed in two different ways, depending on how you specified your storage configuration in your <a href="/docs/rook/v0.6/cluster-crd.html#cluster-settings">Cluster spec</a>.</p>
<ul>
  <li><strong>Use all nodes:</strong> all storage nodes in the cluster will be managed by a single daemon set.
Only the one daemon set will need to be edited to update the image version, then each OSD pod will need to be deleted so that a new pod will be created by the daemon set to take its place.</li>
  <li><strong>Specify individual nodes:</strong> each storage node specified in the cluster spec will be managed by its own individual replica set.
Each of these replica sets will need to be edited to update the image version, then each OSD pod will need to be deleted so its replica set will start a new pod on the new version to replace it.</li>
</ul>

<p>In this example, we are going to walk through the case where <code class="language-plaintext highlighter-rouge">useAllNodes: true</code> was set in the cluster spec, so there will be a single daemon set managing all the OSD pods.</p>

<p>Let’s edit the image version of the pod template in the daemon set:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook <span class="nb">set </span>image daemonset/rook-ceph-osd rook-ceph-osd<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>Once the daemon set is updated, we can begin deleting each OSD pod <strong>one at a time</strong> and verifying a new one comes up to replace it that is running the new version.
After each pod, the cluster health and OSD status should remain or return to an okay state as described in the <a href="#health-verification">health verification section</a>.
To get the names of all the OSD pods, the following can be used:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-osd <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\n"}{end}'</span>
</code></pre></div></div>

<p>Below is an example of deleting just one of the OSD pods (note that the names of your OSD pods will be different):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook delete pod rook-ceph-osd-kcj8f
</code></pre></div></div>

<p>The status and version for all OSD pods can be collected with the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-osd <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{" "}{.status.phase}{" "}{.spec.containers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<p>Remember after each OSD pod to verify the cluster health using the instructions found in the <a href="#health-verification">health verification section</a>.</p>

<h3 id="ceph-manager">Ceph Manager</h3>
<p>Similar to the Rook API and operator, the Ceph manager pods are managed by a deployment.
We will edit the deployment to use the new image version of <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook <span class="nb">set </span>image deployment/rook-ceph-mgr0 rook-ceph-mgr0<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>To verify that the manager pod is <code class="language-plaintext highlighter-rouge">Running</code> and on the new version, use the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-mgr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{" "}{.status.phase}{" "}{.spec.containers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<h3 id="optional-components">Optional Components</h3>
<p>If you have optionally installed either <a href="/docs/rook/v0.6/k8s-object.html">object storage</a> or a <a href="/docs/rook/v0.6/k8s-filesystem.html">shared file system</a> in your Rook cluster, the sections below will provide guidance on how to update them as well.
They are both managed by deployments, which we have already covered in this guide, so the instructions will be brief.</p>

<h4 id="object-storage-rgw">Object Storage (RGW)</h4>
<p>If you have object storage installed, first edit the RGW deployment to use the new image version of <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook <span class="nb">set </span>image deployment/rook-ceph-rgw-default rook-ceph-rgw-default<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>To verify that the RGW pod is <code class="language-plaintext highlighter-rouge">Running</code> and on the new version, use the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-rgw <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{" "}{.status.phase}{" "}{.spec.containers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<h4 id="shared-file-system-mds">Shared File System (MDS)</h4>
<p>If you have a shared file system installed, first edit the MDS deployment to use the new image version of <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook <span class="nb">set </span>image deployment/rook-ceph-mds rook-ceph-mds<span class="o">=</span>rook/rook:v0.5.1
</code></pre></div></div>

<p>To verify that the MDS pod is <code class="language-plaintext highlighter-rouge">Running</code> and on the new version, use the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> rook get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rook-ceph-mds <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{" "}{.status.phase}{" "}{.spec.containers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<h2 id="completion">Completion</h2>
<p>At this point, your Rook cluster should be fully upgraded to running version <code class="language-plaintext highlighter-rouge">rook/rook:v0.5.1</code> and the cluster should be healthy according to the steps in the <a href="#health-verification">health verification section</a>.</p>

<h2 id="upgrading-kubernetes">Upgrading Kubernetes</h2>
<p>:warning: Rook cluster installations on Kubernetes prior to version 1.7.x, use <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-third-party-resource/">ThirdPartyResource</a> that have been deprecated as of 1.7 and removed in 1.8. If upgrading your Kubernetes cluster Rook TPRs have to be migrated to CustomResourceDefinition (CRD) following <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/migrate-third-party-resource/">Kubernetes documentation</a>. Rook TPRs that require migration during upgrade are:</p>
<ul>
  <li>Cluster</li>
  <li>Pool</li>
  <li>ObjectStore</li>
  <li>Filesystem</li>
  <li>VolumeAttachment</li>
</ul>

    </div>
  </div>
</div>

<script>
  var menu = [];
  var BASE_PATH = "";

  function add(name, url, isChild, current) {
    var item = { name: name, url: url, current: current };
    var container = menu;
    if (isChild && menu.length > 0) {
      menu[menu.length-1].children = menu[menu.length-1].children || [];
      container = menu[menu.length-1].children;
      if (current) {
        menu[menu.length-1].childCurrent = true;
      }
    }
    container.push(item);
  }

  
    add(
      "Rook",
      "/docs/rook/v0.6/",
      false,
      false
    );
  
    add(
      "Kubernetes",
      "/docs/rook/v0.6/kubernetes.html",
      false,
      false
    );
  
    add(
      "Prerequisites",
      "/docs/rook/v0.6/k8s-pre-reqs.html",
      true,
      false
    );
  
    add(
      "Block Storage",
      "/docs/rook/v0.6/k8s-block.html",
      true,
      false
    );
  
    add(
      "Object Storage",
      "/docs/rook/v0.6/k8s-object.html",
      true,
      false
    );
  
    add(
      "Shared File System",
      "/docs/rook/v0.6/k8s-filesystem.html",
      true,
      false
    );
  
    add(
      "Monitoring",
      "/docs/rook/v0.6/k8s-monitoring.html",
      true,
      false
    );
  
    add(
      "Pool CRD",
      "/docs/rook/v0.6/pool-crd.html",
      true,
      false
    );
  
    add(
      "Cluster CRD",
      "/docs/rook/v0.6/cluster-crd.html",
      true,
      false
    );
  
    add(
      "Object Store CRD",
      "/docs/rook/v0.6/object-store-crd.html",
      true,
      false
    );
  
    add(
      "File System CRD",
      "/docs/rook/v0.6/filesystem-crd.html",
      true,
      false
    );
  
    add(
      "Helm Chart",
      "/docs/rook/v0.6/helm-operator.html",
      true,
      false
    );
  
    add(
      "Upgrading Rook",
      "/docs/rook/v0.6/upgrade.html",
      true,
      true
    );
  
    add(
      "Rook Client",
      "/docs/rook/v0.6/client.html",
      false,
      false
    );
  
    add(
      "Contributing",
      "/docs/rook/v0.6/development-flow.html",
      false,
      false
    );
  
    add(
      "Toolbox",
      "/docs/rook/v0.6/toolbox.html",
      false,
      false
    );
  
    add(
      "Advanced Configuration",
      "/docs/rook/v0.6/advanced-configuration.html",
      true,
      false
    );
  
    add(
      "Common Problems",
      "/docs/rook/v0.6/common-problems.html",
      false,
      false
    );
  

  function getEntry(item) {
    var itemDom = document.createElement('li');

    if (item.current) {
      itemDom.innerHTML = item.name;
      itemDom.classList.add('current');
    } else {
      itemDom.innerHTML = '<a href="' + item.url + '">' + item.name + '</a>';
    }

    return itemDom;
  }

  // Flush css changes as explained in: https://stackoverflow.com/a/34726346
  // and more completely: https://stackoverflow.com/a/6956049
  function flushCss(element) {
    element.offsetHeight;
  }

  function addArrow(itemDom) {
    var MAIN_ITEM_HEIGHT = 24;
    var BOTTOM_PADDING = 20;
    var arrowDom = document.createElement('a');
    arrowDom.classList.add('arrow');
    arrowDom.innerHTML = '<img src="' + BASE_PATH + '/images/arrow.svg" />';
    arrowDom.onclick = function(itemDom) {
      return function () {
        // Calculated full height of the opened list
        var fullHeight = MAIN_ITEM_HEIGHT + BOTTOM_PADDING + itemDom.lastChild.clientHeight + 'px';

        itemDom.classList.toggle('open');

        if (itemDom.classList.contains('open')) {
          itemDom.style.height = fullHeight;
        } else {
          // If the list height is auto we have to set it to fullHeight
          // without tranistion before we shrink it to collapsed height
          if (itemDom.style.height === 'auto') {
            itemDom.style.transition = 'none';
            itemDom.style.height = fullHeight;
            flushCss(itemDom);
            itemDom.style.transition = '';
          }
          itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
        }

        return false;
      };
    }(itemDom);
    itemDom.appendChild(arrowDom);

    if ((item.current && item.children) || item.childCurrent) {
      itemDom.classList.add('open');
      itemDom.style.height = 'auto';
    } else {
      itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
    }
  }

  var menuDom = document.getElementById('docs-ul');
  for (var i = 0; i < menu.length; i++) {
    var item = menu[i];
    var itemDom = getEntry(item);

    if (item.childCurrent) {
      itemDom.classList.add('childCurrent');
    }

    if (item.children) {
      addArrow(itemDom);
      itemDom.classList.add('children');
      var children = document.createElement('ul');
      for (var j = 0; j < item.children.length; j++) {
        children.appendChild(getEntry(item.children[j]));
      }
      itemDom.appendChild(children);
    }
    menuDom.appendChild(itemDom);
  }
</script>
</div></main>
    <footer id="footer" aria-label="Footer">
  <div class="top">
    <a href="//www.cncf.io">
      <img
        class="cncf"
        src="/images/cncf.png"
        srcset="/images/cncf@2x.png 2x, /images/cncf@3x.png 3x" />
    </a>
    <p>We are a Cloud Native Computing Foundation graduated project.</p>
  </div>
  <div class="middle">
    <div class="grid-center">
      <div class="col_sm-12">
        <span>Getting Started</span>
        <a href="//github.com/rook/rook">GitHub</a>
        <a href="/docs/rook/v1.9/">Documentation</a>
        <a href="//github.com/rook/rook/blob/master/CONTRIBUTING.md#how-to-contribute">How to Contribute</a>
      </div>
      <div class="col_sm-12">
        <span>Community</span>
        <a href="//slack.rook.io/">Slack</a>
        <a href="//twitter.com/rook_io">Twitter</a>
        <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
        <a href="//blog.rook.io/">Blog</a>
      </div>
      <div class="col_sm-12">
        <span>Contact</span>
        <a href="mailto:cncf-rook-info@lists.cncf.io">Email</a>
        <a href="//github.com/rook/rook/issues">Feature request</a>
      </div>
      <div class="col_sm-12">
        <span>Top Contributors</span>
        <a href="//cloudical.io/">Cloudical</a>
        <a href="//cybozu.com">Cybozu, Inc</a>
        <a href="//www.redhat.com">Red Hat</a>
        <a href="//www.suse.com/">SUSE</a>
        <a href="//upbound.io">Upbound</a>
      </div>
    </div>
  </div>
  <div class="bottom">
    <div class="grid-center">
      <div class="col-8">
        <a class="logo" href="/">
          <img src="/images/rook-logo-small.svg" alt="rook.io" />
        </a>
        <p>
          &#169; Rook Authors 2022. Documentation distributed under
          <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>.
        </p>
        <p>
          &#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
          registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
          <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.
        </p>
      </div>
    </div>
  </div>
</footer>


  <script src="/js/anchor.js"></script>
  <script>
    anchors.options = {
      placement: 'right',
      icon: '#',
    }

    document.addEventListener('DOMContentLoaded', function(event) {
      anchors.add('.docs-text h1, .docs-text h2, .docs-text h3, .docs-text h4, .docs-text h5, .docs-text h6');
    });
  </script>




    
  </body>
</html>
