












































<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    
    <meta name="robots" content="noindex">
    

    <title>Ceph Docs</title>

    <link rel="canonical" href="https://rook.io/docs/rook/v1.0/ceph-upgrade.html">

    <link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/images/favicon_16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon_32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon_48x48.png" sizes="48x48" />
<link rel="icon" type="image/png" href="/images/favicon_192x192.png" sizes="192x192" />


    <link href="//fonts.googleapis.com/css?family=Montserrat:500|Open+Sans:300,400,600" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/main.css">
    
      <link rel="stylesheet" href="/css/docs.css" />
    
  </head>
  <body>
    <nav id="navigation" aria-label="Navigation">
  <div>
    <div class="logo">
      <a href="/"><img src="/images/rook-logo.svg"/></a>
    </div>
    <div
      class="hamburger-controls"
      onclick="if (document.body.classList.contains('menu-open')) { document.body.classList.remove('menu-open') } else { document.body.classList.add('menu-open') }; return false;">
      <span></span> <span></span> <span></span>
    </div>
    <ul class="links">
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Documentation</a>
        <div class="dropdown-content">
          <a href="/docs/rook/v1.9/">Ceph</a>
          <a href="/docs/cassandra/v1.7/">Cassandra</a>
          <a href="/docs/nfs/v1.7/">NFS</a>
        </div>
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Community</a>
        <div class="dropdown-content">
          <a href="//github.com/rook/rook">GitHub</a>
          <a href="//slack.rook.io/">Slack</a>
          <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
          <a href="//twitter.com/rook_io">Twitter</a>
        </div>
      </li>
      <li><a href="//blog.rook.io/">Blog</a></li>
      <li><a class="button small" href="/docs/rook/v1.9/quickstart.html">Get Started</a></li>
    </ul>
  </div>
</nav>

    <main id="content" aria-label="Content"><div>



















<section class="docs-header">
  <h1>Ceph</h1>
  <div class="versions">
    <a role="button" href="javascript:void(0)">Rook Ceph v1.0</a>
    <div class="versions-dropdown-content">
      
        <a href="/docs/rook/v1.9/ceph-upgrade.html">Rook Ceph v1.9</a>
      
        <a href="/docs/rook/v1.8/ceph-upgrade.html">Rook Ceph v1.8</a>
      
        <a href="/docs/rook/v1.7/ceph-upgrade.html">Rook Ceph v1.7</a>
      
        <a href="/docs/rook/v1.6/ceph-upgrade.html">Rook Ceph v1.6</a>
      
        <a href="/docs/rook/v1.5/ceph-upgrade.html">Rook Ceph v1.5</a>
      
        <a href="/docs/rook/v1.4/ceph-upgrade.html">Rook Ceph v1.4</a>
      
        <a href="/docs/rook/v1.3/ceph-upgrade.html">Rook Ceph v1.3</a>
      
        <a href="/docs/rook/v1.2/ceph-upgrade.html">Rook Ceph v1.2</a>
      
        <a href="/docs/rook/v1.1/ceph-upgrade.html">Rook Ceph v1.1</a>
      
        <a href="/docs/rook/v1.0/ceph-upgrade.html" class="active">Rook Ceph v1.0</a>
      
        <a href="/docs/rook/v0.9/ceph-upgrade.html">Rook Ceph v0.9</a>
      
        <a href="/docs/rook/v0.8/ceph-upgrade.html">Rook Ceph v0.8</a>
      
        <a href="/docs/rook/v0.7/ceph-upgrade.html">Rook Ceph v0.7</a>
      
        <a href="/docs/rook/v0.6/ceph-upgrade.html">Rook Ceph v0.6</a>
      
        <a href="/docs/rook/v0.5/ceph-upgrade.html">Rook Ceph v0.5</a>
      
        <a href="/docs/rook/latest/ceph-upgrade.html">Rook Ceph latest</a>
      
    </div>
    <img src="/images/arrow.svg" />
  </div>
</section>
<div class="page">
  <div class="docs-menu">
      <ul id="docs-ul"></ul>
  </div>
  <div class="docs-content">
    <div class="docs-actions">
      <a id="edit" href="https://github.com/rook/rook/blob/master/Documentation/ceph-upgrade.md">Edit on GitHub</a>
    </div>
    
      <div class="alert old">
        <p><b>PLEASE NOTE</b>: This document applies to v1.0 version and not to the latest <strong>stable</strong> release v1.9</p>
      </div>
    
    <div class="docs-text">
      <h1 id="ceph-upgrades">Ceph Upgrades</h1>
<p>This guide will walk you through the steps to upgrade the software in a Rook-Ceph cluster from one
version to the next. This includes both the Rook-Ceph operator software itself as well as the Ceph
cluster software.</p>

<p>With the release of Rook 1.0, upgrades for both the operator and for Ceph are nearly entirely
automated save for where Rook’s permissions need to be explicitly updated by an admin. Achieving the
level of upgrade automation has been refined by community feedback, and we will always be open to
further feedback for improving automation and improving Rook.</p>

<p>We welcome feedback and opening issues!</p>

<h2 id="supported-versions">Supported Versions</h2>
<p>The supported version for this upgrade guide is <strong>from a 0.9 release to a 1.0 release</strong>. This guide
supports upgrades only between the official releases. Container images for official releases are
hosted on the Docker Hub project <a href="https://hub.docker.com/r/rook/ceph/tags">rook/ceph</a> and are
denoted by tags <code class="language-plaintext highlighter-rouge">vX.Y.Z</code> or <code class="language-plaintext highlighter-rouge">vX.Y.Z-stable</code>; these two formats are synonymous.</p>

<p>For a guide to upgrade previous versions of Rook, please refer to the version of documentation for
those releases.</p>
<ul>
  <li><a href="https://rook.io/docs/rook/v0.9/ceph-upgrade.html">Upgrade 0.8 to 0.9</a></li>
  <li><a href="https://rook.io/docs/rook/v0.8/upgrade.html">Upgrade 0.7 to 0.8</a></li>
  <li><a href="https://rook.io/docs/rook/v0.7/upgrade.html">Upgrade 0.6 to 0.7</a></li>
  <li><a href="https://rook.io/docs/rook/v0.6/upgrade.html">Upgrade 0.5 to 0.6</a></li>
</ul>

<h2 id="considerations">Considerations</h2>
<p>With this upgrade guide, there are a few notes to consider:</p>
<ul>
  <li><strong>WARNING:</strong> Upgrading a Rook cluster is not without risk. There may be unexpected issues or
obstacles that damage the integrity and health of your storage cluster, including data loss. Only
proceed with this guide if you are comfortable with that.</li>
  <li>The Rook cluster’s storage may be unavailable for short periods during the upgrade process for
both Rook operator updates and for Ceph version updates.</li>
  <li>We recommend that you read this document in full before you undertake a Rook cluster upgrade.</li>
</ul>

<h1 id="upgrading-the-rook-ceph-operator">Upgrading the Rook-Ceph Operator</h1>

<h2 id="patch-release-upgrades">Patch Release Upgrades</h2>
<p>Unless otherwise noted due to extenuating requirements, upgrades from one patch release of Rook to
another are as simple as updating the image of the Rook operator. For example, when Rook v1.0.6 is
released, the process of updating from v1.0.0 should be as simple as running the following:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl -n rook-ceph-system set image deploy/rook-ceph-operator rook-ceph-operator=rook/ceph:v1.0.6
</code></pre></div></div>

<h2 id="prerequisites">Prerequisites</h2>
<p>We will do all our work in the Ceph example manifests directory.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> <span class="nv">$YOUR_ROOK_REPO</span>/cluster/examples/kubernetes/ceph/
</code></pre></div></div>

<p>Unless your Rook cluster was created with customized namespaces, namespaces for Rook clusters
created before v0.8 are likely to be <code class="language-plaintext highlighter-rouge">rook-system</code> and <code class="language-plaintext highlighter-rouge">rook</code>, and for Rook-Ceph clusters created
with v0.8 or after, <code class="language-plaintext highlighter-rouge">rook-ceph-system</code> and <code class="language-plaintext highlighter-rouge">rook-ceph</code>. With this guide, we do our best not to
assume the namespaces in your cluster. To make things as easy as possible, modify and use the below
snippet to configure your environment. We will use these environment variables throughout this
document.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Parameterize the environment</span>
<span class="nb">export </span><span class="nv">ROOK_SYSTEM_NAMESPACE</span><span class="o">=</span><span class="s2">"rook-ceph-system"</span>
<span class="nb">export </span><span class="nv">ROOK_NAMESPACE</span><span class="o">=</span><span class="s2">"rook-ceph"</span>
</code></pre></div></div>

<p>In order to successfully upgrade a Rook cluster, the following prerequisites must be met:</p>
<ul>
  <li>The cluster should be in a healthy state with full functionality.
Review the <a href="#health-verification">health verification section</a> in order to verify your cluster is
in a good starting state.</li>
  <li>All pods consuming Rook storage should be created, running, and in a steady state. No Rook
persistent volumes should be in the act of being created or deleted.</li>
</ul>

<h2 id="health-verification">Health Verification</h2>
<p>Before we begin the upgrade process, let’s first review some ways that you can verify the health of
your cluster, ensuring that the upgrade is going smoothly after each step. Most of the health
verification checks for your cluster during the upgrade process can be performed with the Rook
toolbox. For more information about how to run the toolbox, please visit the
<a href="/docs/rook/v1.0/ceph-toolbox.html#running-the-toolbox-in-kubernetes">Rook toolbox readme</a>.</p>

<p>See the common issues pages for troubleshooting and correcting health issues:</p>
<ul>
  <li><a href="/docs/rook/v1.0/common-issues.html">General troubleshooting</a></li>
  <li><a href="/docs/rook/v1.0/ceph-common-issues.html">Ceph troubleshooting</a></li>
</ul>

<h3 id="pods-all-running">Pods all Running</h3>
<p>In a healthy Rook cluster, the operator, the agents and all Rook namespace pods should be in the
<code class="language-plaintext highlighter-rouge">Running</code> state and have few, if any, pod restarts. To verify this, run the following commands:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_SYSTEM_NAMESPACE</span> get pods
kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pods
</code></pre></div></div>

<h3 id="status-output">Status Output</h3>
<p>The Rook toolbox contains the Ceph tools that can give you status details of the cluster with the
<code class="language-plaintext highlighter-rouge">ceph status</code> command. Let’s look at an output sample and review some of the details:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nv">TOOLS_POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pod <span class="nt">-l</span> <span class="s2">"app=rook-ceph-tools"</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="o">&gt;</span> kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$TOOLS_POD</span> <span class="nt">--</span> ceph status
  cluster:
    <span class="nb">id</span>:     fe7ae378-dc77-46a1-801b-de05286aa78e
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum rook-ceph-mon0,rook-ceph-mon1,rook-ceph-mon2
    mgr: rook-ceph-mgr0<span class="o">(</span>active<span class="o">)</span>
    osd: 1 osds: 1 up, 1 <span class="k">in

  </span>data:
    pools:   1 pools, 100 pgs
    objects: 0 objects, 0 bytes
    usage:   2049 MB used, 15466 MB / 17516 MB avail
    pgs:     100 active+clean
</code></pre></div></div>

<p>In the output above, note the following indications that the cluster is in a healthy state:</p>
<ul>
  <li>Cluster health: The overall cluster status is <code class="language-plaintext highlighter-rouge">HEALTH_OK</code> and there are no warning or error status
messages displayed.</li>
  <li>Monitors (mon):  All of the monitors are included in the <code class="language-plaintext highlighter-rouge">quorum</code> list.</li>
  <li>OSDs (osd): All OSDs are <code class="language-plaintext highlighter-rouge">up</code> and <code class="language-plaintext highlighter-rouge">in</code>.</li>
  <li>Manager (mgr): The Ceph manager is in the <code class="language-plaintext highlighter-rouge">active</code> state.</li>
  <li>Placement groups (pgs): All PGs are in the <code class="language-plaintext highlighter-rouge">active+clean</code> state.</li>
</ul>

<p>If your <code class="language-plaintext highlighter-rouge">ceph status</code> output has deviations from the general good health described above, there may
be an issue that needs to be investigated further. There are other commands you may run for more
details on the health of the system, such as <code class="language-plaintext highlighter-rouge">ceph osd status</code>.</p>

<h3 id="container-versions">Container Versions</h3>
<p>The container version running in a specific pod in the Rook cluster can be verified in its pod spec
output. For example for the monitor pod <code class="language-plaintext highlighter-rouge">mon-b</code>, we can verify the container version it is running
with the below commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pod <span class="nt">-o</span> custom-columns<span class="o">=</span>name:.metadata.name <span class="nt">--no-headers</span> | <span class="nb">grep </span>rook-ceph-mon-b<span class="si">)</span>
kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pod <span class="k">${</span><span class="nv">POD_NAME</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.containers[0].image}'</span>
</code></pre></div></div>

<h3 id="all-pods-status-and-version">All Pods Status and Version</h3>
<p>The status and container versions for all Rook pods can be collected all at once with the following
commands:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_SYSTEM_NAMESPACE</span> get pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\n\t"}{.status.phase}{"\t"}{.spec.containers[0].image}{"\t"}{.spec.initContainers[0]}{"\n"}{end}'</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\n\t"}{.status.phase}{"\t"}{.spec.containers[0].image}{"\t"}{.spec.initContainers[0].image}{"\n"}{end}'</span>
</code></pre></div></div>

<p>Rook 1.0 also introduces the <code class="language-plaintext highlighter-rouge">rook-version</code> label to Ceph controller resources. For various
resource controllers, a summary of the resource controllers can be gained with the commands below.
These will report the requested, updated, and currently available replicas for various Rook-Ceph
resources in addition to the version of Rook for resources managed by the updated Rook-Ceph operator.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get deployments <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"  \treq/upd/avl: "}{.spec.replicas}{"/"}{.status.updatedReplicas}{"/"}{.status.readyReplicas}{"  \trook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span>

kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get daemonsets <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"  \treq/upd/avl: "}{.status.desiredNumberScheduled}{"/"}{.status.updatedNumberScheduled}{"/"}{.status.numberAvailable}{"  \trook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span>

kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get <span class="nb">jobs</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"  \tsucceeded: "}{.status.succeeded}{"      \trook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span>
</code></pre></div></div>

<h3 id="rook-volume-health">Rook Volume Health</h3>
<p>Any pod that is using a Rook volume should also remain healthy:</p>
<ul>
  <li>The pod should be in the <code class="language-plaintext highlighter-rouge">Running</code> state with few, if any, restarts</li>
  <li>There should be no errors in its logs</li>
  <li>The pod should still be able to read and write to the attached Rook volume.</li>
</ul>

<h2 id="rook-operator-upgrade-process">Rook Operator Upgrade Process</h2>
<p>In the examples given in this guide, we will be upgrading a live Rook cluster running <code class="language-plaintext highlighter-rouge">v0.9.3</code> to
the <code class="language-plaintext highlighter-rouge">v1.0.0</code>. This upgrade should work from any official patch release of Rook 0.9 to any official
patch release of 1.0. We will further assume that your previous cluster was created using an earlier
version of this guide and manifests. If you have created custom manifests, these steps may not work
as written.</p>

<p><strong>Rook release from master are expressly unsupported.</strong> It is strongly recommended that you use
<a href="https://github.com/rook/rook/releases">official releases</a> of Rook, as unreleased versions from the
master branch are subject to changes and incompatibilities that will not be supported in the
official releases. Builds from the master branch can have functionality changed and even removed at
any time without compatibility support and without prior notice.</p>

<p>Let’s get started!</p>

<h3 id="1-configure-manifests">1. Configure manifests</h3>
<p><strong>IMPORTANT:</strong> Ensure that you are using the latest manifests from the <code class="language-plaintext highlighter-rouge">release-1.0</code> branch. If you
have custom configuration options set in your 0.9 manifests, you will need to also alter those
values in the 1.0 manifests.</p>

<p>If your cluster does not use the <code class="language-plaintext highlighter-rouge">rook-ceph-system</code> and <code class="language-plaintext highlighter-rouge">rook-ceph</code> namespaces, you will need to
replace all manifest references to these namespaces with references to those used by your cluster.
We can use a few simple <code class="language-plaintext highlighter-rouge">sed</code> commands to do this for all manifests at once.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Replace yaml file namespaces with sed (and make backups)</span>
<span class="nb">sed</span> <span class="nt">-i</span>.bak <span class="nt">-e</span> <span class="s2">"s/namespace: rook-ceph-system/namespace: </span><span class="nv">$ROOK_SYSTEM_NAMESPACE</span><span class="s2">/g"</span> <span class="k">*</span>.yaml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s2">"s/namespace: rook-ceph/namespace: </span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">/g"</span> <span class="k">*</span>.yaml
<span class="c"># Reduce clutter by moving the backups we just created</span>
<span class="nb">mkdir </span>backups
<span class="nb">mv</span> <span class="k">*</span>.bak backups/
</code></pre></div></div>

<h3 id="2-update-modified-permissions">2. Update modified permissions</h3>
<p>A few of permissions have been added or modified in v1.0. To make updating these resources easy,
special upgrade manifests have been created.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> upgrade-from-v0.9-delete.yaml
kubectl create <span class="nt">-f</span> upgrade-from-v0.9-create.yaml
</code></pre></div></div>
<p>Upgrade notes have been added to <code class="language-plaintext highlighter-rouge">upgrade-from-v0.9-create.yaml</code> identifying the changes made to 1.0
to aid users in any manifest-related auditing they wish to do.</p>

<h3 id="3-update-the-rook-operator-image">3. Update the Rook operator image</h3>
<p>The largest portion of the upgrade is triggered when the operator’s image is updated to <code class="language-plaintext highlighter-rouge">v1.0.x</code>.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_SYSTEM_NAMESPACE</span> <span class="nb">set </span>image deploy/rook-ceph-operator rook-ceph-operator<span class="o">=</span>rook/ceph:v1.0.6
</code></pre></div></div>

<p>Watch now in amazement as the Ceph mons, mgrs, OSDs, rbd-mirrors, mdses and rgws are terminated and
replaced with updated versions in sequence. The cluster may be offline very briefly as mons update,
and the Ceph Filesystem may fall offline a few times while the mdses are upgrading. This is normal.
Continue on to the next upgrade step while the update is commencing.</p>

<h3 id="4-wait-for-the-upgrade-to-complete">4. Wait for the upgrade to complete</h3>
<p>Before moving on, the Ceph cluster’s core (RADOS) components should be fully updated.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>watch <span class="nt">--exec</span> kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get deployments <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"  \treq/upd/avl: "}{.spec.replicas}{"/"}{.status.updatedReplicas}{"/"}{.status.readyReplicas}{"  \trook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span>
</code></pre></div></div>

<p>As an example, this cluster is midway through updating the OSDs from 0.9 to 1.0. When all
deployments report <code class="language-plaintext highlighter-rouge">1/1/1</code> availability and <code class="language-plaintext highlighter-rouge">rook-version=v1.0.0</code>, the Ceph cluster’s core
components are fully updated.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Every 2.0s: kubectl <span class="nt">-n</span> rook-ceph get deployment <span class="nt">-o</span> j...

rook-ceph-mgr-a         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>v1.0.0
rook-ceph-mon-a         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>v1.0.0
rook-ceph-mon-b         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>v1.0.0
rook-ceph-mon-c         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>v1.0.0
rook-ceph-osd-0         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>v1.0.0
rook-ceph-osd-1         req/upd/avl: 1//        rook-version<span class="o">=</span>v1.0.0
rook-ceph-osd-2         req/upd/avl: 1/1/1      rook-version<span class="o">=</span>
</code></pre></div></div>

<p>The mdses and rgws are the last daemons to update. An easy check to see if the upgrade is totally
finished is to check that there is only one <code class="language-plaintext highlighter-rouge">rook-version</code> reported across the cluster. It is safe
to proceed with the next step before the mdses and rgws are finished updating.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get deployment <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{"rook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span> <span class="o">&amp;&amp;</span> kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get daemonset <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{"rook-version="}{.metadata.labels.rook-version}{"\n"}{end}'</span><span class="o">)</span> | <span class="nb">uniq</span>
<span class="c"># This cluster is not yet finished:</span>
<span class="c">#   rook-version=</span>
<span class="c">#   rook-version=v1.0.0</span>
<span class="c"># This cluster is finished:</span>
<span class="c">#   rook-version=v1.0.0</span>
</code></pre></div></div>

<h3 id="5-verify-the-updated-cluster">5. Verify the updated cluster</h3>
<p>At this point, your Rook operator should be running version <code class="language-plaintext highlighter-rouge">rook/ceph:v1.0.6</code></p>

<p>Verify the Ceph cluster’s health using the <a href="#health-verification">health verification section</a>.</p>

<h3 id="6-update-the-mon-ports">6. Update the Mon Ports</h3>

<p>The port on which the mons are listening has changed in the 1.0 release in order to support the new
msgr2 protocol in Nautilus. Previously, the mons were listening on port 6790 by default.
In 1.0 now they are expected to be listening on port 6789. To ensure an uninterrupted
upgrade to 1.0, the operator configures the existing mons to continue listening on port 6790.</p>

<p>It is recommended that the mons be re-configured to listen on the new default port <strong>before upgrading to Ceph Nautilus</strong>;
however, the steps outlined below will still work after an upgrade to Nautilus.
Instead of changing the port, the recommended process is to failover the mons,
which will create new mons on port 6789. While the operator will automate most of this process, there are
several steps required to induce the operator to failover a mon.</p>
<ol>
  <li>Cause the mon to fail by setting the replicas on the mon deployment to zero. For example, if your mon is named <code class="language-plaintext highlighter-rouge">mon-a</code>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">kubectl -n $ROOK_NAMESPACE scale deploy rook-ceph-mon-a --replicas=0</code></li>
    </ul>
  </li>
  <li>Wait for 5-10 minutes for the operator to fail over the mon. You will see messages in the operator log that the mon is down and will be failed over after a timeout.
The length of the timeout is dependent on the setting <code class="language-plaintext highlighter-rouge">ROOK_MON_OUT_INTERVAL</code> in the Rook operator deployment (operator.yaml).</li>
  <li>After the timeout, a new mon will be started and the old mon deployment will be automatically removed.</li>
  <li>Confirm in the toolbox that all mons are in quorum: <code class="language-plaintext highlighter-rouge">ceph status</code>. Do not continue if they are not in quorum.</li>
  <li>Repeat steps 1-5 for each of the old mons</li>
</ol>

<p>Note that clients connected with the Rook flex driver will be automatically updated when the mons are failed over.
No intervention is needed for the clients to find the new mons.</p>

<h2 id="ceph-version-upgrades">Ceph Version Upgrades</h2>
<p>Rook 1.0 is the last Rook release which will support Ceph’s Luminous (v12.x.x) version. Users are
advised to upgrade to Mimic (v13.x.x) or Nautilus (v14.x.x) now.</p>

<p><strong>IMPORTANT: This section only applies to clusters already running Rook 1.0</strong></p>

<h3 id="ceph-images">Ceph images</h3>
<p>Official Ceph container images can be found on <a href="https://hub.docker.com/r/ceph/ceph/tags/">Docker Hub</a>.
These images are tagged in a few ways:</p>
<ul>
  <li>The most explicit form of tags are full-ceph-version-and-build tags (e.g., <code class="language-plaintext highlighter-rouge">v13.2.2-20181023</code>).
These tags are recommended for production clusters, as there is no possibility for the cluster to
be heterogeneous with respect to the version of Ceph running in containers.</li>
  <li>Ceph major version tags (e.g., <code class="language-plaintext highlighter-rouge">v13</code>) are useful for development and test clusters so that the
latest version of Ceph is always available.</li>
</ul>

<p><strong>Ceph containers other than the official images from the registry above will not be supported.</strong></p>

<h3 id="example-upgrade-to-ceph-nautilus">Example upgrade to Ceph Nautilus</h3>

<h4 id="1-update-the-main-ceph-daemons">1. Update the main Ceph daemons</h4>
<p>The majority of the upgrade will be handled by the Rook operator. Begin the upgrade by changing the
Ceph image field in the cluster CRD (<code class="language-plaintext highlighter-rouge">spec:cephVersion:image</code>).</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NEW_CEPH_IMAGE</span><span class="o">=</span><span class="s1">'ceph/ceph:v14.2.1-20190430'</span>
<span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span>  <span class="c"># change if your cluster name is not the Rook namespace</span>
kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> patch CephCluster <span class="nv">$CLUSTER_NAME</span> <span class="nt">--type</span><span class="o">=</span>merge <span class="se">\</span>
  <span class="nt">-p</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">spec</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\"</span><span class="s2">cephVersion</span><span class="se">\"</span><span class="s2">: {</span><span class="se">\"</span><span class="s2">image</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="nv">$NEW_CEPH_IMAGE</span><span class="se">\"</span><span class="s2">}}}"</span>
</code></pre></div></div>

<h4 id="2-wait-for-the-daemon-pod-updates-to-complete">2. Wait for the daemon pod updates to complete</h4>
<p>As with upgrading Rook, you must now wait for the upgrade to complete. Determining when the Ceph
version has fully updated is rather simple.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>watch kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> describe pods | <span class="nb">grep</span> <span class="s2">"Image:.*ceph/ceph"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span>
<span class="c"># This cluster is not yet finished:</span>
<span class="c">#      Image:         ceph/ceph:v13.2.2-20181023</span>
<span class="c">#      Image:         ceph/ceph:v14.2.1-20190430</span>
<span class="c"># This cluster is also finished:</span>
<span class="c">#      Image:         ceph/ceph:v14.2.1-20190430</span>
</code></pre></div></div>

<h4 id="3-enable-nautilus-features">3. Enable Nautilus features</h4>
<p>When upgrading to Nautilus (v14.x.x), a final command should be issued to Ceph to take advantage of
the latest Ceph features. This does not apply for upgrades to Mimic (v13.x.x)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TOOLS_POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> get pod <span class="nt">-l</span> <span class="s2">"app=rook-ceph-tools"</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
kubectl <span class="nt">-n</span> <span class="nv">$ROOK_NAMESPACE</span> <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$TOOLS_POD</span> <span class="nt">--</span> ceph osd require-osd-release nautilus
</code></pre></div></div>

<h4 id="4-verify-the-updated-cluster">4. Verify the updated cluster</h4>
<p>Verify the Ceph cluster’s health using the <a href="#health-verification">health verification section</a>.</p>

<p>If you see a health warning about enabling msgr2, please see the section above on <a href="#6-update-the-mon-ports">Updating the Mon Ports</a>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@minikube /]# ceph -s
  cluster:
    id:     b02807da-986a-40b0-ab7a-fa57582b1e4f
    health: HEALTH_WARN
            3 monitors have not enabled msgr2
</code></pre></div></div>

<p>Alternatively, this warning can suppressed if a temporary workaround is needed.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph config set global mon_warn_on_msgr2_not_enabled false
</code></pre></div></div>

    </div>
  </div>
</div>

<script>
  var menu = [];
  var BASE_PATH = "";

  function add(name, url, isChild, current) {
    var item = { name: name, url: url, current: current };
    var container = menu;
    if (isChild && menu.length > 0) {
      menu[menu.length-1].children = menu[menu.length-1].children || [];
      container = menu[menu.length-1].children;
      if (current) {
        menu[menu.length-1].childCurrent = true;
      }
    }
    container.push(item);
  }

  
    add(
      "Rook",
      "/docs/rook/v1.0/",
      false,
      false
    );
  
    add(
      "Quickstart",
      "/docs/rook/v1.0/quickstart-toc.html",
      false,
      false
    );
  
    add(
      "Cassandra",
      "/docs/rook/v1.0/cassandra.html",
      true,
      false
    );
  
    add(
      "Ceph Storage",
      "/docs/rook/v1.0/ceph-quickstart.html",
      true,
      false
    );
  
    add(
      "CockroachDB",
      "/docs/rook/v1.0/cockroachdb.html",
      true,
      false
    );
  
    add(
      "EdgeFS Geo-Transparent Storage",
      "/docs/rook/v1.0/edgefs-quickstart.html",
      true,
      false
    );
  
    add(
      "Minio Object Store",
      "/docs/rook/v1.0/minio-object-store.html",
      true,
      false
    );
  
    add(
      "Network File System (NFS)",
      "/docs/rook/v1.0/nfs.html",
      true,
      false
    );
  
    add(
      "Prerequisites",
      "/docs/rook/v1.0/k8s-pre-reqs.html",
      false,
      false
    );
  
    add(
      "FlexVolume Configuration",
      "/docs/rook/v1.0/flexvolume.html",
      true,
      false
    );
  
    add(
      "Ceph cluster Pod Security Policies",
      "/docs/rook/v1.0/ceph-psp.html",
      true,
      false
    );
  
    add(
      "Pod Security Policies",
      "/docs/rook/v1.0/psp.html",
      true,
      false
    );
  
    add(
      "Tectonic Bare Metal",
      "/docs/rook/v1.0/tectonic.html",
      true,
      false
    );
  
    add(
      "OpenShift",
      "/docs/rook/v1.0/openshift.html",
      true,
      false
    );
  
    add(
      "Ceph Storage",
      "/docs/rook/v1.0/ceph-storage.html",
      false,
      false
    );
  
    add(
      "Examples",
      "/docs/rook/v1.0/ceph-examples.html",
      true,
      false
    );
  
    add(
      "Block Storage",
      "/docs/rook/v1.0/ceph-block.html",
      true,
      false
    );
  
    add(
      "Object Storage",
      "/docs/rook/v1.0/ceph-object.html",
      true,
      false
    );
  
    add(
      "Shared File System",
      "/docs/rook/v1.0/ceph-filesystem.html",
      true,
      false
    );
  
    add(
      "Dashboard",
      "/docs/rook/v1.0/ceph-dashboard.html",
      true,
      false
    );
  
    add(
      "Monitoring",
      "/docs/rook/v1.0/ceph-monitoring.html",
      true,
      false
    );
  
    add(
      "Cluster CRD",
      "/docs/rook/v1.0/ceph-cluster-crd.html",
      true,
      false
    );
  
    add(
      "Block Pool CRD",
      "/docs/rook/v1.0/ceph-pool-crd.html",
      true,
      false
    );
  
    add(
      "Object Store CRD",
      "/docs/rook/v1.0/ceph-object-store-crd.html",
      true,
      false
    );
  
    add(
      "Object Store User CRD",
      "/docs/rook/v1.0/ceph-object-store-user-crd.html",
      true,
      false
    );
  
    add(
      "Shared File System CRD",
      "/docs/rook/v1.0/ceph-filesystem-crd.html",
      true,
      false
    );
  
    add(
      "NFS CRD",
      "/docs/rook/v1.0/ceph-nfs-crd.html",
      true,
      false
    );
  
    add(
      "Ceph CSI",
      "/docs/rook/v1.0/ceph-csi-drivers.html",
      true,
      false
    );
  
    add(
      "Upgrades",
      "/docs/rook/v1.0/ceph-upgrade.html",
      true,
      true
    );
  
    add(
      "Cleanup",
      "/docs/rook/v1.0/ceph-teardown.html",
      true,
      false
    );
  
    add(
      "EdgeFS Storage",
      "/docs/rook/v1.0/edgefs-storage.html",
      false,
      false
    );
  
    add(
      "Cluster CRD",
      "/docs/rook/v1.0/edgefs-cluster-crd.html",
      true,
      false
    );
  
    add(
      "ISGW Link CRD",
      "/docs/rook/v1.0/edgefs-isgw-crd.html",
      true,
      false
    );
  
    add(
      "Scale-Out NFS CRD",
      "/docs/rook/v1.0/edgefs-nfs-crd.html",
      true,
      false
    );
  
    add(
      "Edge-X S3 CRD",
      "/docs/rook/v1.0/edgefs-s3x-crd.html",
      true,
      false
    );
  
    add(
      "AWS S3 CRD",
      "/docs/rook/v1.0/edgefs-s3-crd.html",
      true,
      false
    );
  
    add(
      "OpenStack/SWIFT CRD",
      "/docs/rook/v1.0/edgefs-swift-crd.html",
      true,
      false
    );
  
    add(
      "iSCSI Target CRD",
      "/docs/rook/v1.0/edgefs-iscsi-crd.html",
      true,
      false
    );
  
    add(
      "CSI driver",
      "/docs/rook/v1.0/edgefs-csi.html",
      true,
      false
    );
  
    add(
      "Monitoring",
      "/docs/rook/v1.0/edgefs-monitoring.html",
      true,
      false
    );
  
    add(
      "User Interface",
      "/docs/rook/v1.0/edgefs-ui.html",
      true,
      false
    );
  
    add(
      "VDEV Management",
      "/docs/rook/v1.0/edgefs-vdev-management.html",
      true,
      false
    );
  
    add(
      "Upgrade",
      "/docs/rook/v1.0/edgefs-upgrade.html",
      true,
      false
    );
  
    add(
      "Cassandra Cluster CRD",
      "/docs/rook/v1.0/cassandra-cluster-crd.html",
      false,
      false
    );
  
    add(
      "Upgrade",
      "/docs/rook/v1.0/cassandra-operator-upgrade.html",
      true,
      false
    );
  
    add(
      "CockroachDB Cluster CRD",
      "/docs/rook/v1.0/cockroachdb-cluster-crd.html",
      false,
      false
    );
  
    add(
      "Minio Object Store CRD",
      "/docs/rook/v1.0/minio-object-store-crd.html",
      false,
      false
    );
  
    add(
      "NFS Server CRD",
      "/docs/rook/v1.0/nfs-crd.html",
      false,
      false
    );
  
    add(
      "Helm Charts",
      "/docs/rook/v1.0/helm.html",
      false,
      false
    );
  
    add(
      "Ceph Operator",
      "/docs/rook/v1.0/helm-operator.html",
      true,
      false
    );
  
    add(
      "Common Issues",
      "/docs/rook/v1.0/common-issues.html",
      false,
      false
    );
  
    add(
      "Ceph Common Issues",
      "/docs/rook/v1.0/ceph-common-issues.html",
      true,
      false
    );
  
    add(
      "Ceph Tools",
      "/docs/rook/v1.0/ceph-tools.html",
      false,
      false
    );
  
    add(
      "Toolbox",
      "/docs/rook/v1.0/ceph-toolbox.html",
      true,
      false
    );
  
    add(
      "Direct Tools",
      "/docs/rook/v1.0/direct-tools.html",
      true,
      false
    );
  
    add(
      "Advanced Configuration",
      "/docs/rook/v1.0/ceph-advanced-configuration.html",
      true,
      false
    );
  
    add(
      "Container Linux",
      "/docs/rook/v1.0/container-linux.html",
      true,
      false
    );
  
    add(
      "Disaster Recovery",
      "/docs/rook/v1.0/disaster-recovery.html",
      true,
      false
    );
  
    add(
      "Contributing",
      "/docs/rook/v1.0/development-flow.html",
      false,
      false
    );
  
    add(
      "Multi-Node Test Environment",
      "/docs/rook/v1.0/development-environment.html",
      true,
      false
    );
  

  function getEntry(item) {
    var itemDom = document.createElement('li');

    if (item.current) {
      itemDom.innerHTML = item.name;
      itemDom.classList.add('current');
    } else {
      itemDom.innerHTML = '<a href="' + item.url + '">' + item.name + '</a>';
    }

    return itemDom;
  }

  // Flush css changes as explained in: https://stackoverflow.com/a/34726346
  // and more completely: https://stackoverflow.com/a/6956049
  function flushCss(element) {
    element.offsetHeight;
  }

  function addArrow(itemDom) {
    var MAIN_ITEM_HEIGHT = 24;
    var BOTTOM_PADDING = 20;
    var arrowDom = document.createElement('a');
    arrowDom.classList.add('arrow');
    arrowDom.innerHTML = '<img src="' + BASE_PATH + '/images/arrow.svg" />';
    arrowDom.onclick = function(itemDom) {
      return function () {
        // Calculated full height of the opened list
        var fullHeight = MAIN_ITEM_HEIGHT + BOTTOM_PADDING + itemDom.lastChild.clientHeight + 'px';

        itemDom.classList.toggle('open');

        if (itemDom.classList.contains('open')) {
          itemDom.style.height = fullHeight;
        } else {
          // If the list height is auto we have to set it to fullHeight
          // without tranistion before we shrink it to collapsed height
          if (itemDom.style.height === 'auto') {
            itemDom.style.transition = 'none';
            itemDom.style.height = fullHeight;
            flushCss(itemDom);
            itemDom.style.transition = '';
          }
          itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
        }

        return false;
      };
    }(itemDom);
    itemDom.appendChild(arrowDom);

    if ((item.current && item.children) || item.childCurrent) {
      itemDom.classList.add('open');
      itemDom.style.height = 'auto';
    } else {
      itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
    }
  }

  var menuDom = document.getElementById('docs-ul');
  for (var i = 0; i < menu.length; i++) {
    var item = menu[i];
    var itemDom = getEntry(item);

    if (item.childCurrent) {
      itemDom.classList.add('childCurrent');
    }

    if (item.children) {
      addArrow(itemDom);
      itemDom.classList.add('children');
      var children = document.createElement('ul');
      for (var j = 0; j < item.children.length; j++) {
        children.appendChild(getEntry(item.children[j]));
      }
      itemDom.appendChild(children);
    }
    menuDom.appendChild(itemDom);
  }
</script>
</div></main>
    <footer id="footer" aria-label="Footer">
  <div class="top">
    <a href="//www.cncf.io">
      <img
        class="cncf"
        src="/images/cncf.png"
        srcset="/images/cncf@2x.png 2x, /images/cncf@3x.png 3x" />
    </a>
    <p>We are a Cloud Native Computing Foundation graduated project.</p>
  </div>
  <div class="middle">
    <div class="grid-center">
      <div class="col_sm-12">
        <span>Getting Started</span>
        <a href="//github.com/rook/rook">GitHub</a>
        <a href="/docs/rook/v1.9/">Documentation</a>
        <a href="//github.com/rook/rook/blob/master/CONTRIBUTING.md#how-to-contribute">How to Contribute</a>
      </div>
      <div class="col_sm-12">
        <span>Community</span>
        <a href="//slack.rook.io/">Slack</a>
        <a href="//twitter.com/rook_io">Twitter</a>
        <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
        <a href="//blog.rook.io/">Blog</a>
      </div>
      <div class="col_sm-12">
        <span>Contact</span>
        <a href="mailto:cncf-rook-info@lists.cncf.io">Email</a>
        <a href="//github.com/rook/rook/issues">Feature request</a>
      </div>
      <div class="col_sm-12">
        <span>Top Contributors</span>
        <a href="//cloudical.io/">Cloudical</a>
        <a href="//cybozu.com">Cybozu, Inc</a>
        <a href="//www.redhat.com">Red Hat</a>
        <a href="//www.suse.com/">SUSE</a>
        <a href="//upbound.io">Upbound</a>
      </div>
    </div>
  </div>
  <div class="bottom">
    <div class="grid-center">
      <div class="col-8">
        <a class="logo" href="/">
          <img src="/images/rook-logo-small.svg" alt="rook.io" />
        </a>
        <p>
          &#169; Rook Authors 2022. Documentation distributed under
          <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>.
        </p>
        <p>
          &#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
          registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
          <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.
        </p>
      </div>
    </div>
  </div>
</footer>


  <script src="/js/anchor.js"></script>
  <script>
    anchors.options = {
      placement: 'right',
      icon: '#',
    }

    document.addEventListener('DOMContentLoaded', function(event) {
      anchors.add('.docs-text h1, .docs-text h2, .docs-text h3, .docs-text h4, .docs-text h5, .docs-text h6');
    });
  </script>




    
  </body>
</html>
