












































<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    

    <title>Cassandra Docs</title>

    <link rel="canonical" href="https://rook.io/docs/cassandra/v1.7/cassandra-operator-upgrade.html">

    <link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/images/favicon_16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon_32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon_48x48.png" sizes="48x48" />
<link rel="icon" type="image/png" href="/images/favicon_192x192.png" sizes="192x192" />


    <link href="//fonts.googleapis.com/css?family=Montserrat:500|Open+Sans:300,400,600" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/main.css">
    
      <link rel="stylesheet" href="/css/docs.css" />
    
  </head>
  <body>
    <nav id="navigation" aria-label="Navigation">
  <div>
    <div class="logo">
      <a href="/"><img src="/images/rook-logo.svg"/></a>
    </div>
    <div
      class="hamburger-controls"
      onclick="if (document.body.classList.contains('menu-open')) { document.body.classList.remove('menu-open') } else { document.body.classList.add('menu-open') }; return false;">
      <span></span> <span></span> <span></span>
    </div>
    <ul class="links">
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Documentation</a>
        <div class="dropdown-content">
          <a href="/docs/rook/v1.9/">Ceph</a>
          <a href="/docs/cassandra/v1.7/">Cassandra</a>
          <a href="/docs/nfs/v1.7/">NFS</a>
        </div>
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Community</a>
        <div class="dropdown-content">
          <a href="//github.com/rook/rook">GitHub</a>
          <a href="//slack.rook.io/">Slack</a>
          <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
          <a href="//twitter.com/rook_io">Twitter</a>
        </div>
      </li>
      <li><a href="//blog.rook.io/">Blog</a></li>
      <li><a class="button small" href="/docs/rook/v1.9/quickstart.html">Get Started</a></li>
    </ul>
  </div>
</nav>

    <main id="content" aria-label="Content"><div>



















<section class="docs-header">
  <h1>Cassandra</h1>
  <div class="versions">
    <a role="button" href="javascript:void(0)">Rook Cassandra v1.7</a>
    <div class="versions-dropdown-content">
      
        <a href="/docs/cassandra/v1.7/cassandra-operator-upgrade.html" class="active">Rook Cassandra v1.7</a>
      
        <a href="/docs/cassandra/latest/cassandra-operator-upgrade.html">Rook Cassandra latest</a>
      
    </div>
    <img src="/images/arrow.svg" />
  </div>
</section>
<div class="page">
  <div class="docs-menu">
      <ul id="docs-ul"></ul>
  </div>
  <div class="docs-content">
    <div class="docs-actions">
      <a id="edit" href="https://github.com/rook/cassandra/blob/master/Documentation/cassandra-operator-upgrade.md">Edit on GitHub</a>
    </div>
    
    <div class="docs-text">
      <h1 id="cassandra-operator-upgrades">Cassandra Operator Upgrades</h1>

<p><strong>The Rook Cassandra operator is <a href="https://github.com/rook/cassandra#deprecated">deprecated</a></strong></p>

<p>This guide will walk you through the manual steps to upgrade the software in Cassandra Operator from one version to the next. The cassandra operator is made up of two parts:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">Operator</code> binary that runs as a standalone application, watches the Cassandra Cluster CRD and makes administrative decisions.</li>
  <li>A sidecar that runs alongside each member of a Cassandra Cluster. We will call this component <code class="language-plaintext highlighter-rouge">Sidecar</code>.</li>
</ol>

<p>Both components should be updated. This is a very manual process at the moment, but it should be automated soon in the future, once the Cassandra Operator reaches the beta stage.</p>

<h2 id="considerations">Considerations</h2>

<p>With this upgrade guide, there are a few notes to consider:</p>

<ul>
  <li><strong>WARNING</strong>: Upgrading a Rook cluster is not without risk. There may be unexpected issues or
obstacles that damage the integrity and health of your storage cluster, including data loss. Only
proceed with this guide if you are comfortable with that. It is recommended that you backup your data before proceeding.</li>
  <li><strong>WARNING</strong>: The current process to upgrade REQUIRES the cluster to be unavailable for the time of the upgrade.</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>If you are upgrading from v0.9.2 to a later version, the mount point of the PVC for each member has changed because it was wrong. Please follow the <a href="#before-upgrading-from-v092">migration instructions for upgrading from v0.9.2</a>.</li>
  <li>Before starting the procedure, ensure that your Cassandra Clusters are in a healthy state. You can check a Cassandra Clusterâ€™s health by using <code class="language-plaintext highlighter-rouge">kubectl describe clusters.cassandra.rook.io $NAME -n $NAMESPACE</code> and ensuring that for each rack in the Status, <code class="language-plaintext highlighter-rouge">readyMembers</code> equals <code class="language-plaintext highlighter-rouge">members</code>.</li>
</ul>

<h2 id="procedure">Procedure</h2>

<ol>
  <li>Because each version of the <code class="language-plaintext highlighter-rouge">Operator</code> is designed to work with the same version of the <code class="language-plaintext highlighter-rouge">Sidecar</code>, they must be upgraded together. In order to avoid mixing versions between the <code class="language-plaintext highlighter-rouge">Operator</code> and <code class="language-plaintext highlighter-rouge">Sidecar</code>, we first delete every Cassandra Cluster CRD in our Kubernetes cluster, after first backing up their manifests. This will not delete your data because the PVCs will be retained even if the Cassandra Cluster object is deleted. Example:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>Assumes cluster rook-cassandra <span class="k">in </span>namespace rook-cassandra
<span class="go">NAME=rook-cassandra
NAMESPACE=rook-cassandra

</span><span class="gp">kubectl get clusters.cassandra.rook.io $</span>NAME <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> yaml <span class="o">&gt;</span> <span class="nv">$NAME</span>.yaml
<span class="gp">kubectl delete clusters.cassandra.rook.io $</span>NAME <span class="nt">-n</span> <span class="nv">$NAMESPACE</span>
</code></pre></div></div>

<ol>
  <li>After that, we upgrade the version of the <code class="language-plaintext highlighter-rouge">Operator</code>. To achieve that, we patch the StatefulSet running the <code class="language-plaintext highlighter-rouge">Operator</code>:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>Assumes Operator is running <span class="k">in </span>StatefulSet rook-cassandra-operator
<span class="gp">#</span><span class="w"> </span><span class="k">in </span>namespace rook-cassandra-system
<span class="go">
kubectl set image sts/rook-cassandra-operator rook-cassandra-operator=rook/cassandra:v0.9.x -n rook-cassandra-system
</span></code></pre></div></div>

<p>After patching, ensure that the operator pods are running successfully:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">kubectl get pods -n rook-cassandra-system
</span></code></pre></div></div>

<ol>
  <li>Recreate the manifests previously deleted:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">kubectl apply -f $</span>NAME.yaml
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Operator</code> will pick up the newly created Cassandra Clusters and recreate them with the correct version of the sidecar.</p>

<h2 id="before-upgrading-from-v092">Before Upgrading from v0.9.2</h2>

<p>Do the following before proceeding:</p>

<ul>
  <li>For each member of each cluster:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">POD=rook-cassandra-us-east-1-us-east-1a-0
NAMESPACE=rook-cassandra

</span><span class="gp">#</span><span class="w"> </span>Change /var/lib/cassandra to /var/lib/scylla <span class="k">for </span>a scylla cluster
<span class="gp">kubectl exec $</span>POD <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--</span> /bin/bash
<span class="go">
mkdir /var/lib/cassandra/data/data
shopt -s extglob
mv !(/var/lib/cassandra/data) /var/lib/cassandra/data/data
</span></code></pre></div></div>

<p>After that continue with <a href="#procedure">the upgrade procedure</a>.</p>

    </div>
  </div>
</div>

<script>
  var menu = [];
  var BASE_PATH = "";

  function add(name, url, isChild, current) {
    var item = { name: name, url: url, current: current };
    var container = menu;
    if (isChild && menu.length > 0) {
      menu[menu.length-1].children = menu[menu.length-1].children || [];
      container = menu[menu.length-1].children;
      if (current) {
        menu[menu.length-1].childCurrent = true;
      }
    }
    container.push(item);
  }

  
    add(
      "Rook",
      "/docs/cassandra/v1.7/",
      false,
      false
    );
  
    add(
      "Prerequisites",
      "/docs/cassandra/v1.7/k8s-pre-reqs.html",
      false,
      false
    );
  
    add(
      "Cassandra Quickstart",
      "/docs/cassandra/v1.7/quickstart.html",
      false,
      false
    );
  
    add(
      "Cassandra Cluster CRD",
      "/docs/cassandra/v1.7/cassandra-cluster-crd.html",
      false,
      false
    );
  
    add(
      "Cassandra Upgrade",
      "/docs/cassandra/v1.7/cassandra-operator-upgrade.html",
      false,
      true
    );
  
    add(
      "Common Issues",
      "/docs/cassandra/v1.7/common-issues.html",
      false,
      false
    );
  
    add(
      "Contributing",
      "/docs/cassandra/v1.7/development-flow.html",
      false,
      false
    );
  

  function getEntry(item) {
    var itemDom = document.createElement('li');

    if (item.current) {
      itemDom.innerHTML = item.name;
      itemDom.classList.add('current');
    } else {
      itemDom.innerHTML = '<a href="' + item.url + '">' + item.name + '</a>';
    }

    return itemDom;
  }

  // Flush css changes as explained in: https://stackoverflow.com/a/34726346
  // and more completely: https://stackoverflow.com/a/6956049
  function flushCss(element) {
    element.offsetHeight;
  }

  function addArrow(itemDom) {
    var MAIN_ITEM_HEIGHT = 24;
    var BOTTOM_PADDING = 20;
    var arrowDom = document.createElement('a');
    arrowDom.classList.add('arrow');
    arrowDom.innerHTML = '<img src="' + BASE_PATH + '/images/arrow.svg" />';
    arrowDom.onclick = function(itemDom) {
      return function () {
        // Calculated full height of the opened list
        var fullHeight = MAIN_ITEM_HEIGHT + BOTTOM_PADDING + itemDom.lastChild.clientHeight + 'px';

        itemDom.classList.toggle('open');

        if (itemDom.classList.contains('open')) {
          itemDom.style.height = fullHeight;
        } else {
          // If the list height is auto we have to set it to fullHeight
          // without tranistion before we shrink it to collapsed height
          if (itemDom.style.height === 'auto') {
            itemDom.style.transition = 'none';
            itemDom.style.height = fullHeight;
            flushCss(itemDom);
            itemDom.style.transition = '';
          }
          itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
        }

        return false;
      };
    }(itemDom);
    itemDom.appendChild(arrowDom);

    if ((item.current && item.children) || item.childCurrent) {
      itemDom.classList.add('open');
      itemDom.style.height = 'auto';
    } else {
      itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
    }
  }

  var menuDom = document.getElementById('docs-ul');
  for (var i = 0; i < menu.length; i++) {
    var item = menu[i];
    var itemDom = getEntry(item);

    if (item.childCurrent) {
      itemDom.classList.add('childCurrent');
    }

    if (item.children) {
      addArrow(itemDom);
      itemDom.classList.add('children');
      var children = document.createElement('ul');
      for (var j = 0; j < item.children.length; j++) {
        children.appendChild(getEntry(item.children[j]));
      }
      itemDom.appendChild(children);
    }
    menuDom.appendChild(itemDom);
  }
</script>
</div></main>
    <footer id="footer" aria-label="Footer">
  <div class="top">
    <a href="//www.cncf.io">
      <img
        class="cncf"
        src="/images/cncf.png"
        srcset="/images/cncf@2x.png 2x, /images/cncf@3x.png 3x" />
    </a>
    <p>We are a Cloud Native Computing Foundation graduated project.</p>
  </div>
  <div class="middle">
    <div class="grid-center">
      <div class="col_sm-12">
        <span>Getting Started</span>
        <a href="//github.com/rook/rook">GitHub</a>
        <a href="/docs/rook/v1.9/">Documentation</a>
        <a href="//github.com/rook/rook/blob/master/CONTRIBUTING.md#how-to-contribute">How to Contribute</a>
      </div>
      <div class="col_sm-12">
        <span>Community</span>
        <a href="//slack.rook.io/">Slack</a>
        <a href="//twitter.com/rook_io">Twitter</a>
        <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
        <a href="//blog.rook.io/">Blog</a>
      </div>
      <div class="col_sm-12">
        <span>Contact</span>
        <a href="mailto:cncf-rook-info@lists.cncf.io">Email</a>
        <a href="//github.com/rook/rook/issues">Feature request</a>
      </div>
      <div class="col_sm-12">
        <span>Top Contributors</span>
        <a href="//cloudical.io/">Cloudical</a>
        <a href="//cybozu.com">Cybozu, Inc</a>
        <a href="//www.redhat.com">Red Hat</a>
        <a href="//www.suse.com/">SUSE</a>
        <a href="//upbound.io">Upbound</a>
      </div>
    </div>
  </div>
  <div class="bottom">
    <div class="grid-center">
      <div class="col-8">
        <a class="logo" href="/">
          <img src="/images/rook-logo-small.svg" alt="rook.io" />
        </a>
        <p>
          &#169; Rook Authors 2022. Documentation distributed under
          <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>.
        </p>
        <p>
          &#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
          registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
          <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.
        </p>
      </div>
    </div>
  </div>
</footer>


  <script src="/js/anchor.js"></script>
  <script>
    anchors.options = {
      placement: 'right',
      icon: '#',
    }

    document.addEventListener('DOMContentLoaded', function(event) {
      anchors.add('.docs-text h1, .docs-text h2, .docs-text h3, .docs-text h4, .docs-text h5, .docs-text h6');
    });
  </script>




    
  </body>
</html>
